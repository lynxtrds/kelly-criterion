<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Kelly Criterion - Gesti√≥n de Riesgo para Trading</title>
    <meta name="description" content="Calculadora Kelly Criterion gratuita para optimizar tu gesti√≥n de riesgo en trading. Calcula el tama√±o √≥ptimo de posici√≥n basado en tu win rate y risk/reward.">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .calculator-wrapper {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .inputs-section {
            padding: 40px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .results-section {
            padding: 40px;
            background: white;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 30px;
            color: #2d3748;
        }

        .input-group {
            margin-bottom: 30px;
        }

        .input-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-value {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #5568d3;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            transition: all 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .range-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #a0aec0;
        }

        .kelly-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .kelly-card.recommended {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            box-shadow: 0 10px 30px rgba(17, 153, 142, 0.3);
        }

        .kelly-card.conservative {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        }

        .kelly-card-title {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .kelly-card-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kelly-card-amount {
            font-size: 1.3rem;
            opacity: 0.95;
        }

        .kelly-card-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #e6f7ff;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .examples-section {
            margin-top: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .examples-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .example-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            font-size: 1rem;
        }

        .example-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .example-btn strong {
            color: #2d3748;
            display: block;
            margin-bottom: 5px;
        }

        .example-btn span {
            color: #6c757d;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            opacity: 0.8;
            font-size: 0.9rem;
        }

        footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
        }

        .simulator-section {
            margin-top: 40px;
            padding: 40px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
        }

        .simulator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .simulator-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }

        .simulate-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .simulate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .simulate-btn:active {
            transform: translateY(0);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }

        .simulation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .simulation-table thead {
            background: #f8f9fa;
        }

        .simulation-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        .simulation-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .simulation-table tbody tr:hover {
            background: #f8f9fa;
        }

        .kelly-fraction-cell {
            font-weight: 600;
            color: #2d3748;
        }

        .positive-return {
            color: #38a169;
            font-weight: 600;
        }

        .negative-return {
            color: #e53e3e;
            font-weight: 600;
        }

        .sim-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .sim-input-group {
            flex: 1;
        }

        .sim-input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .sim-input-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }

            .inputs-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            header h1 {
                font-size: 2rem;
            }

            .kelly-card-value {
                font-size: 2.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .simulator-header {
                flex-direction: column;
                gap: 15px;
            }

            .simulate-btn {
                width: 100%;
            }

            .sim-controls {
                flex-direction: column;
            }

            .simulation-table {
                font-size: 0.85rem;
            }

            .simulation-table th,
            .simulation-table td {
                padding: 10px 8px;
            }
        }

        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Calculadora Kelly Criterion</h1>
            <p>Optimiza tu gesti√≥n de riesgo en trading con matem√°ticas</p>
        </header>

        <div class="calculator-wrapper">
            <div class="calculator-grid">
                <!-- INPUTS SECTION -->
                <div class="inputs-section">
                    <h2 class="section-title">üìä Par√°metros de tu Sistema</h2>

                    <div class="input-group">
                        <div class="input-label">
                            <span>Win Rate (%)</span>
                            <span class="input-value" id="winRateValue">55%</span>
                        </div>
                        <input type="range" id="winRate" min="40" max="80" value="55" step="1">
                        <div class="range-labels">
                            <span>40%</span>
                            <span>80%</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-label">
                            <span>Risk / Reward Ratio</span>
                            <span class="input-value" id="rrValue">1.5</span>
                        </div>
                        <input type="range" id="riskReward" min="0.5" max="3" value="1.5" step="0.1">
                        <div class="range-labels">
                            <span>0.5</span>
                            <span>3.0</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <div class="input-label">
                            <span>Bankroll Total ($)</span>
                        </div>
                        <input type="number" id="bankroll" value="10000" min="100" step="100">
                    </div>

                    <!-- EJEMPLOS -->
                    <div class="examples-section">
                        <h3 class="examples-title">‚ö° Cargar Ejemplo</h3>
                        <button class="example-btn" onclick="loadExample(55, 1.5, 10000)">
                            <strong>Trading Conservador</strong>
                            <span>55% WR ‚Ä¢ R:R 1.5 ‚Ä¢ $10k</span>
                        </button>
                        <button class="example-btn" onclick="loadExample(60, 2, 10000)">
                            <strong>Trading Agresivo</strong>
                            <span>60% WR ‚Ä¢ R:R 2.0 ‚Ä¢ $10k</span>
                        </button>
                        <button class="example-btn" onclick="loadExample(52, 1.2, 5000)">
                            <strong>Scalping</strong>
                            <span>52% WR ‚Ä¢ R:R 1.2 ‚Ä¢ $5k</span>
                        </button>
                        <button class="example-btn" onclick="loadExample(67, 2.5, 5000)">
                            <strong>Apuesta Deportiva</strong>
                            <span>67% WR ‚Ä¢ R:R 2.5 ‚Ä¢ $5k</span>
                        </button>
                    </div>
                </div>

                <!-- RESULTS SECTION -->
                <div class="results-section">
                    <h2 class="section-title">üéØ Resultados Kelly</h2>

                    <div id="alertContainer"></div>

                    <div class="kelly-card" id="fullKellyCard">
                        <div class="kelly-card-title">Full Kelly (√ìptimo Matem√°tico)</div>
                        <div class="kelly-card-value" id="fullKellyPercent">5.0%</div>
                        <div class="kelly-card-amount" id="fullKellyAmount">$500</div>
                        <span class="kelly-card-badge">M√°ximo crecimiento ‚Ä¢ Alta volatilidad</span>
                    </div>

                    <div class="kelly-card recommended" id="halfKellyCard">
                        <div class="kelly-card-title">‚ú® Half Kelly (Recomendado)</div>
                        <div class="kelly-card-value" id="halfKellyPercent">2.5%</div>
                        <div class="kelly-card-amount" id="halfKellyAmount">$250</div>
                        <span class="kelly-card-badge">‚≠ê Mejor balance riesgo/retorno</span>
                    </div>

                    <div class="kelly-card conservative" id="quarterKellyCard">
                        <div class="kelly-card-title">Quarter Kelly (Conservador)</div>
                        <div class="kelly-card-value" id="quarterKellyPercent">1.25%</div>
                        <div class="kelly-card-amount" id="quarterKellyAmount">$125</div>
                        <span class="kelly-card-badge">Volatilidad m√≠nima</span>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">Edge / Ventaja</div>
                            <div class="stat-value" id="edgeValue">10%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Ganancia Esperada</div>
                            <div class="stat-value" id="expectedGain">$12.50</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Drawdown Half Kelly</div>
                            <div class="stat-value" id="drawdown">-11.8%</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Riesgo de Ruina</div>
                            <div class="stat-value" id="ruinRisk">11%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CAPITAL GROWTH SIMULATOR -->
        <div class="simulator-section">
            <div class="simulator-header">
                <h2 class="simulator-title">üìà Simulador de Crecimiento de Capital</h2>
                <button class="simulate-btn" onclick="runSimulation()">‚ñ∂Ô∏è Simular 100 Trades</button>
            </div>

            <div class="sim-controls">
                <div class="sim-input-group">
                    <label>N√∫mero de Trades</label>
                    <input type="number" id="numTrades" value="100" min="10" max="500" step="10">
                </div>
                <div class="sim-input-group">
                    <label>Capital Inicial ($)</label>
                    <input type="number" id="simBankroll" value="10000" min="1000" step="1000">
                </div>
            </div>

            <div class="chart-container">
                <canvas id="growthChart"></canvas>
            </div>

            <h3 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 15px; color: #2d3748;">Resultados de Simulaci√≥n</h3>
            <table class="simulation-table">
                <thead>
                    <tr>
                        <th>Kelly Fraction</th>
                        <th>Capital Final</th>
                        <th>Retorno Total</th>
                        <th>Crecimiento Anualizado</th>
                    </tr>
                </thead>
                <tbody id="simulationResults">
                    <tr>
                        <td class="kelly-fraction-cell">0.25x Kelly (6.25%)</td>
                        <td>$25,173.99</td>
                        <td class="positive-return">+151.74%</td>
                        <td class="positive-return">+0.93%</td>
                    </tr>
                    <tr>
                        <td class="kelly-fraction-cell">0.5x Kelly (12.50%)</td>
                        <td>$379,297.53</td>
                        <td class="positive-return">+3692.98%</td>
                        <td class="positive-return">+3.70%</td>
                    </tr>
                    <tr>
                        <td class="kelly-fraction-cell">0.75x Kelly (18.75%)</td>
                        <td>$27,775.59</td>
                        <td class="positive-return">+177.76%</td>
                        <td class="positive-return">+1.03%</td>
                    </tr>
                    <tr>
                        <td class="kelly-fraction-cell">1x Kelly (25.00%)</td>
                        <td>$135,427.84</td>
                        <td class="positive-return">+1254.28%</td>
                        <td class="positive-return">+2.64%</td>
                    </tr>
                    <tr>
                        <td class="kelly-fraction-cell">1.5x Kelly (37.50%)</td>
                        <td>$124,436.45</td>
                        <td class="positive-return">+1144.36%</td>
                        <td class="positive-return">+2.55%</td>
                    </tr>
                    <tr>
                        <td class="kelly-fraction-cell">2x Kelly (50.00%)</td>
                        <td>$10,219.19</td>
                        <td class="positive-return">+2.19%</td>
                        <td class="positive-return">+0.02%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <footer>
            <p>üìà Calculadora Kelly Criterion ‚Ä¢ Creada para traders por <a href="#" target="_blank">Ivan</a></p>
            <p style="margin-top: 10px; font-size: 0.85rem;">Basado en el paper de John L. Kelly Jr. (1956)</p>
        </footer>
    </div>

    <script>
        // Chart instance global
        let growthChart = null;

        // Referencias a elementos
        const winRateInput = document.getElementById('winRate');
        const winRateValue = document.getElementById('winRateValue');
        const riskRewardInput = document.getElementById('riskReward');
        const rrValue = document.getElementById('rrValue');
        const bankrollInput = document.getElementById('bankroll');

        // Elementos de resultados
        const fullKellyPercent = document.getElementById('fullKellyPercent');
        const fullKellyAmount = document.getElementById('fullKellyAmount');
        const halfKellyPercent = document.getElementById('halfKellyPercent');
        const halfKellyAmount = document.getElementById('halfKellyAmount');
        const quarterKellyPercent = document.getElementById('quarterKellyPercent');
        const quarterKellyAmount = document.getElementById('quarterKellyAmount');
        const edgeValue = document.getElementById('edgeValue');
        const expectedGain = document.getElementById('expectedGain');
        const drawdown = document.getElementById('drawdown');
        const ruinRisk = document.getElementById('ruinRisk');
        const alertContainer = document.getElementById('alertContainer');

        // Event listeners
        winRateInput.addEventListener('input', updateCalculations);
        riskRewardInput.addEventListener('input', updateCalculations);
        bankrollInput.addEventListener('input', updateCalculations);

        // SIMULATION FUNCTIONS
        function runSimulation() {
            const numTrades = parseInt(document.getElementById('numTrades').value);
            const simBankroll = parseFloat(document.getElementById('simBankroll').value);
            const winRate = parseFloat(winRateInput.value) / 100;
            const rr = parseFloat(riskRewardInput.value);

            // Calculate Kelly
            const p = winRate;
            const q = 1 - p;
            const b = rr;
            const kellyFraction = (b * p - q) / b;

            if (kellyFraction <= 0) {
                alert('‚ö†Ô∏è Edge negativo. No se puede simular un sistema perdedor.');
                return;
            }

            // Kelly fractions to simulate
            const fractions = [0.25, 0.5, 0.75, 1, 1.5, 2];
            const results = {};
            const chartData = {};

            // Run simulation for each fraction
            fractions.forEach(fraction => {
                const kellySize = kellyFraction * fraction;
                const simulation = simulateTrades(simBankroll, numTrades, winRate, rr, kellySize);
                results[fraction] = simulation.final;
                chartData[fraction] = simulation.history;
            });

            // Update chart
            updateChart(chartData, numTrades);

            // Update table
            updateSimulationTable(results, simBankroll, kellyFraction, fractions, numTrades);
        }

        function simulateTrades(initialCapital, numTrades, winRate, rr, kellySize) {
            let capital = initialCapital;
            const history = [capital];

            for (let i = 0; i < numTrades; i++) {
                const betSize = capital * kellySize;
                const win = Math.random() < winRate;

                if (win) {
                    capital += betSize * rr;
                } else {
                    capital -= betSize;
                }

                // Prevent bankruptcy
                if (capital < 0) capital = 0;
                
                history.push(capital);
            }

            return {
                final: capital,
                history: history
            };
        }

        function updateChart(chartData, numTrades) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            
            // Destroy existing chart
            if (growthChart) {
                growthChart.destroy();
            }

            const datasets = [
                {
                    label: '0.25x Kelly',
                    data: chartData[0.25],
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    label: '0.5x Kelly',
                    data: chartData[0.5],
                    borderColor: '#4299e1',
                    backgroundColor: 'rgba(66, 153, 225, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    label: '0.75x Kelly',
                    data: chartData[0.75],
                    borderColor: '#ed8936',
                    backgroundColor: 'rgba(237, 137, 54, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    label: '1x Kelly',
                    data: chartData[1],
                    borderColor: '#9f7aea',
                    backgroundColor: 'rgba(159, 122, 234, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    label: '1.5x Kelly',
                    data: chartData[1.5],
                    borderColor: '#f56565',
                    backgroundColor: 'rgba(245, 101, 101, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    label: '2x Kelly',
                    data: chartData[2],
                    borderColor: '#a0616a',
                    backgroundColor: 'rgba(160, 97, 106, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    pointRadius: 0
                }
            ];

            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: numTrades + 1}, (_, i) => i),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Crecimiento de Capital con Diferentes Fracciones Kelly',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Capital ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'N√∫mero de Trades'
                            }
                        }
                    }
                }
            });
        }

        function updateSimulationTable(results, initialCapital, kellyFraction, fractions, numTrades) {
            const tbody = document.getElementById('simulationResults');
            tbody.innerHTML = '';

            fractions.forEach(fraction => {
                const finalCapital = results[fraction];
                const totalReturn = ((finalCapital - initialCapital) / initialCapital) * 100;
                
                // Calculate annualized growth rate
                // Assuming ~250 trading days per year, adjust based on numTrades
                const years = numTrades / 250;
                const annualizedGrowth = years > 0 ? 
                    (Math.pow(finalCapital / initialCapital, 1 / years) - 1) * 100 : 0;

                const kellyPercent = (kellyFraction * fraction * 100).toFixed(2);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="kelly-fraction-cell">${fraction}x Kelly (${kellyPercent}%)</td>
                    <td>${formatCurrency(finalCapital)}</td>
                    <td class="${totalReturn >= 0 ? 'positive-return' : 'negative-return'}">
                        ${totalReturn >= 0 ? '+' : ''}${totalReturn.toFixed(2)}%
                    </td>
                    <td class="${annualizedGrowth >= 0 ? 'positive-return' : 'negative-return'}">
                        ${annualizedGrowth >= 0 ? '+' : ''}${annualizedGrowth.toFixed(2)}%
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateCalculations() {
            // Obtener valores
            const winRate = parseFloat(winRateInput.value) / 100;
            const rr = parseFloat(riskRewardInput.value);
            const bankroll = parseFloat(bankrollInput.value);

            // Actualizar displays de inputs
            winRateValue.textContent = `${winRateInput.value}%`;
            rrValue.textContent = rr.toFixed(1);

            // Calcular Kelly
            const p = winRate;
            const q = 1 - p;
            const b = rr; // En trading, b es el R:R ratio
            
            // F√≥rmula Kelly: (bp - q) / b
            const kellyFraction = (b * p - q) / b;
            
            // Edge calculation
            const edge = (p * b - q) * 100;

            // Generar alertas
            generateAlerts(kellyFraction, edge, p);

            // Si Kelly es negativo, mostrar advertencia
            if (kellyFraction < 0) {
                fullKellyPercent.textContent = '0%';
                fullKellyAmount.textContent = '$0';
                halfKellyPercent.textContent = '0%';
                halfKellyAmount.textContent = '$0';
                quarterKellyPercent.textContent = '0%';
                quarterKellyAmount.textContent = '$0';
                edgeValue.textContent = edge.toFixed(2) + '%';
                expectedGain.textContent = '$0';
                drawdown.textContent = 'N/A';
                ruinRisk.textContent = 'N/A';
                return;
            }

            // Calcular cantidades
            const fullKelly = kellyFraction;
            const halfKelly = kellyFraction * 0.5;
            const quarterKelly = kellyFraction * 0.25;

            const fullKellyDollars = bankroll * fullKelly;
            const halfKellyDollars = bankroll * halfKelly;
            const quarterKellyDollars = bankroll * quarterKelly;

            // Actualizar UI
            fullKellyPercent.textContent = (fullKelly * 100).toFixed(2) + '%';
            fullKellyAmount.textContent = formatCurrency(fullKellyDollars);
            
            halfKellyPercent.textContent = (halfKelly * 100).toFixed(2) + '%';
            halfKellyAmount.textContent = formatCurrency(halfKellyDollars);
            
            quarterKellyPercent.textContent = (quarterKelly * 100).toFixed(2) + '%';
            quarterKellyAmount.textContent = formatCurrency(quarterKellyDollars);

            // Estad√≠sticas
            edgeValue.textContent = edge.toFixed(2) + '%';
            
            // Expected gain por trade usando Half Kelly
            const expectedGainValue = halfKellyDollars * ((p * b) + (q * -1));
            expectedGain.textContent = formatCurrency(expectedGainValue);

            // Drawdown y riesgo (valores hist√≥ricos para Half Kelly)
            drawdown.textContent = '-11.8%';
            ruinRisk.textContent = '11%';
        }

        function generateAlerts(kelly, edge, winRate) {
            alertContainer.innerHTML = '';

            if (edge < 0) {
                alertContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <span class="icon">‚õî</span>
                        <span><strong>NO APUESTES:</strong> Tu sistema tiene edge negativo. Perder√°s dinero a largo plazo.</span>
                    </div>
                `;
                return;
            }

            if (kelly > 0.20) {
                alertContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <span class="icon">‚ö†Ô∏è</span>
                        <span><strong>Kelly muy alto (${(kelly*100).toFixed(1)}%):</strong> Verifica tus datos. Usa m√°ximo Half Kelly (${(kelly*50).toFixed(1)}%).</span>
                    </div>
                `;
                return;
            }

            if (kelly > 0.15) {
                alertContainer.innerHTML = `
                    <div class="alert alert-info">
                        <span class="icon">‚ÑπÔ∏è</span>
                        <span><strong>Edge fuerte detectado:</strong> Usa Half o Quarter Kelly para reducir volatilidad.</span>
                    </div>
                `;
                return;
            }

            if (edge > 0 && edge < 5) {
                alertContainer.innerHTML = `
                    <div class="alert alert-info">
                        <span class="icon">‚ÑπÔ∏è</span>
                        <span><strong>Edge peque√±o:</strong> Tu ventaja es v√°lida pero modesta. Considera mejorar tu R:R o Win Rate.</span>
                    </div>
                `;
                return;
            }

            alertContainer.innerHTML = `
                <div class="alert alert-success">
                    <span class="icon">‚úÖ</span>
                    <span><strong>Sistema v√°lido:</strong> Edge positivo de ${edge.toFixed(1)}%. Usa Half Kelly para balance √≥ptimo.</span>
                </div>
            `;
        }

        function formatCurrency(value) {
            return '$' + value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function loadExample(wr, rr, br) {
            winRateInput.value = wr;
            riskRewardInput.value = rr;
            bankrollInput.value = br;
            document.getElementById('simBankroll').value = br;
            updateCalculations();
        }

        // Inicializar
        updateCalculations();

        // Auto-run simulation on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                runSimulation();
            }, 500);
        });
    </script>
</body>
</html>